ALTER TABLE WYCIECZKI ADD liczba_wolnych_miejsc INT;

CREATE PROCEDURE Wylicz_wolne_miejsca
AS

BEGIN
  for v_wyc IN (SELECT ID_WYCIECZKI,LICZBA_MIEJSC,LICZBA_WOLNYCH_MIEJSC FROM WYCIECZKI) LOOP

  Update WYCIECZKI set LICZBA_WOLNYCH_MIEJSC=v_wyc.LICZBA_MIEJSC-(SELECT count(*) FROM REZERWACJE
    where STATUS!='A' and REZERWACJE.ID_WYCIECZKI=v_wyc.ID_WYCIECZKI)
  WHERE WYCIECZKI.ID_WYCIECZKI=v_wyc.ID_WYCIECZKI;

  END LOOP;

END Wylicz_wolne_miejsca;
/



--3.4

CREATE VIEW wycieczki_miejsca_w
  AS     SELECT
  w.ID_WYCIECZKI,w.NAZWA,w.KRAJ,w.DATA,w.LICZBA_WOLNYCH_MIEJSC
         FROM WYCIECZKI w;



--3.5

CREATE VIEW wycieczki_miejsca_dostepnych
  AS     SELECT
  w.ID_WYCIECZKI,w.NAZWA,w.KRAJ,w.DATA,w.LICZBA_WOLNYCH_MIEJSC
         FROM WYCIECZKI w
where LICZBA_WOLNYCH_MIEJSC>0;



--

CREATE or REPLACE PROCEDURE Wylicz_wolne_miejsca
AS

BEGIN
  for v_wyc IN (SELECT ID_WYCIECZKI,LICZBA_MIEJSC,LICZBA_WOLNYCH_MIEJSC FROM WYCIECZKI) LOOP

  Update WYCIECZKI set LICZBA_WOLNYCH_MIEJSC=v_wyc.LICZBA_MIEJSC-(SELECT count(*) FROM REZERWACJE
    where STATUS!='A' and REZERWACJE.ID_WYCIECZKI=v_wyc.ID_WYCIECZKI)
  WHERE WYCIECZKI.ID_WYCIECZKI=v_wyc.ID_WYCIECZKI;

  END LOOP;

END Wylicz_wolne_miejsca;


  BEGIN
    Wylicz_wolne_miejsca();
  END;